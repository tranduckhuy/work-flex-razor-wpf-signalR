@page
@model WorkFlex.Web.Pages.User.ProfileModel
@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "Profile";

    var successMsg = TempData["SuccessMessage"] as string;
    var failedMsg = TempData["FailedMessage"] as string;
    var user = Model.User;
}

@if (user != null)
{
    <style>
        .avatar-badge {
            position: absolute;
            left: 116px;
            bottom: -8px;
            padding: 4px 8px;
            border-radius: 50%;
            background: #f4f4f4;
            border: 4px solid #fff;
        }
    </style>


    <div id="toast"></div>
    if (!string.IsNullOrEmpty(successMsg))
    {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                setTimeout(function () {
                    toast({
                        title: "Success",
                        message: "@successMsg",
                        type: "success",
                        duration: 3000,
                    });
                }, 600);
            });
        </script>
    } else if (!string.IsNullOrEmpty(failedMsg))
    {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                setTimeout(function () {
                    toast({
                        title: "Failed",
                        message: "@failedMsg",
                        type: "danger",
                        duration: 3000,
                    });
                }, 600);
            });
        </script>
    }

    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="sherah-body">
                    <!-- Dashboard Inner -->
                    <div class="sherah-dsinner">

                        <div class="row mg-top-30">
                            <div class="col-12 sherah-flex-between">
                                <!-- Sherah Breadcrumb -->
                                <div class="sherah-breadcrumb">
                                    <h2 class="sherah-breadcrumb__title">Profile</h2>
                                    <ul class="sherah-breadcrumb__list">
                                        <li><a asp-page="/">Home</a></li>
                                        <li class="active"><a href="#!">Personal Information</a></li>
                                    </ul>
                                </div>
                                <!-- End Sherah Breadcrumb -->
                            </div>
                        </div>

                        <div class="sharah-profile--main sherah-default-bg sharah-border mg-top-40">

                            <!-- Sharah Profile header -->
                            <div class="sherah-userprofile__header">
                                <img id="backgroundImage" src="@user.BackgroundImg" alt="Background" style="height:190px;max-height:200px;">
                                @if (Model.IsYourProfile)
                                {
                                    <div class="sherah-userprofile__right">
                                        <label for="backgroundFile" class="sherah-btn sherah-btn__white" style="padding:16px 20px;cursor:pointer;">
                                            <input type="file" id="backgroundFile" style="display:none;" accept=".png,.jpg" />
                                            <i class="fas fa-camera" style="color:#333;font-size:16px;"></i>
                                            Change Background
                                        </label>
                                    </div>
                                }
                            </div>

                            <div class="col-12" style="position:relative;">
                                <!-- Profile Info -->
                                <div class="sherah-profile-info">
                                    <div class="sherah-profile-info__thumb" style="position:relative;">
                                        <img id="avatarImage" src="@user.Avatar" alt="Avatar">
                                        @if (Model.IsYourProfile)
                                        {
                                            <label for="avatarFile" class="avatar-badge" style="cursor:pointer;">
                                                <input type="file" id="avatarFile" style="display:none;" accept=".png,.jpg" />
                                                <i class="fas fa-camera" style="color:#5f5f5f;font-size:16px;"></i>
                                            </label>
                                        }
                                        <h3 class="sherah-profile-info__name">
                                            @user.FirstName @user.LastName
                                            <span>@user.Email</span>
                                        </h3>
                                    </div>
                                </div>
                                <!-- End Profile Info -->
                            </div>

                            <!-- Profile Inner Section -->
                            <div class="sherah-upinner">
                                <div class="row">
                                    <div class="col-12">
                                        <!-- Profile Overview -->
                                        <div class="sherah-upcontent mg-top-30">
                                            <!-- Tab List -->
                                            <div class="sherah-pcats__bar">
                                                <div class="sherah-pcats__list list-group" id="list-tab" role="tablist">
                                                    <a class="list-group-item active" data-bs-toggle="list" href="#tab_1" role="tab" style="border:1px solid #E2E7F1">About</a>
                                                    @if (Model.IsYourProfile)
                                                    {
                                                        <a class="list-group-item" data-bs-toggle="list" href="#tab_2" role="tab" style="border:1px solid #E2E7F1">Edit Profile</a>
                                                        <a class="list-group-item" data-bs-toggle="list" href="#tab_3" role="tab" style="border:1px solid #E2E7F1">Change Password</a>
                                                    }
                                                </div>
                                            </div>

                                            <div class="tab-content" id="nav-tabContent">
                                                <div class="tab-pane fade show active" id="tab_1" role="tabpanel" aria-labelledby="nav-home-tab">
                                                    <div class="sherah-upcontent__text sherah-border">
                                                        <!-- Profile Info -->
                                                        <div class="sharah-profile__about">
                                                            <h3 class="sharah-profile__title mg-btm-10">About</h3>
                                                            <p class="sharah-profile__text">@(!string.IsNullOrEmpty(user.Profile.Summary) ? user.Profile.Summary : "Summary not updated yet.")</p>
                                                            <div class="sharah-profile__meta mg-top-40">
                                                                <h4>Headline: @(!string.IsNullOrEmpty(user.Profile.Headline) ? user.Profile.Headline : "")</h4>
                                                                <p class="mg-top-10"><a href="#" class="sherah-color1">@user.Email</a></p>
                                                                <p class="sharah-profile__id mg-top-30">@(user.DateOfBirth != DateTime.MinValue ? user.DateOfBirth.ToShortDateString() : "Date of Birth not updated yet.")</p>
                                                            </div>
                                                        </div>
                                                        <div class="sherah-border-btm mg-top-30"></div>
                                                        <div class="row">
                                                            <div class="col-lg-6 col-md-6 col-12 mg-top-30">
                                                                <h4 class="sherah-info-title mg-btm-20">Contact</h4>
                                                                <ul class="sherah-contact-info">
                                                                    <li class="sherah-border"><span class="sherah-color1__bg--offset"><i class="fas fa-map-marker-alt"></i></span><p id="address-information" style="color:#1a1a1a"></p></li>
                                                                    <li class="sherah-border"><span class="sherah-color1__bg--offset"><i class="far fa-envelope"></i></span>Email : <a href="mailto:@user.Email" style="font-size:16px;text-decoration:underline;">@user.Email</a></li>
                                                                    <li class="sherah-border"><span class="sherah-color1__bg--offset"><i class="fas fa-phone"></i></span>
                                                                        Phone : @if (!string.IsNullOrEmpty(user.Phone))
                                                                        {
                                                                            <a href="tel:@user.Phone">@user.Phone</a>
                                                                        } else
                                                                        {
                                                                            <p style="color:#1a1a1a">Phone not updated yet.</p>
                                                                        }
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                            <div class="col-lg-6 col-md-6 col-12 mg-top-30">
                                                                <h4 class="sherah-info-title mg-btm-20">Social</h4>
                                                                <ul class="sherah-contact-info sherah-contact-social">
                                                                    <li class="sherah-border"><a href="#"><span class="sherah-color1__bg--offset"><i class="fab fa-facebook-f"></i></span>Facebook</a></li>
                                                                    <li class="sherah-border"><a href="#"><span class="sherah-color1__bg--offset"><i class="fab fa-twitter"></i></span>Twitter</a></li>
                                                                    <li class="sherah-border"><a href="#"><span class="sherah-color1__bg--offset"><i class="fab fa-linkedin"></i></span>Linkedin</a></li>
                                                                    <li class="sherah-border"><a href="#"><span class="sherah-color1__bg--offset"><i class="fab fa-dribbble"></i></span>Dribbble</a></li>
                                                                    <li class="sherah-border"><a href="#"><span class="sherah-color1__bg--offset"><i class="fab fa-behance"></i></span>Behance</a></li>
                                                                    <li class="sherah-border"><a href="#"><span class="sherah-color1__bg--offset"><i class="fab fa-youtube"></i></span>Youtube</a></li>
                                                                    <li class="sherah-border"><a href="#"><span class="sherah-color1__bg--offset"><i class="fab fa-instagram"></i></span>Instagram</a></li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                @if (Model.IsYourProfile)
                                                {
                                                    <div class="tab-pane fade" id="tab_2" role="tabpanel" aria-labelledby="nav-home-tab" style="padding: 0 10px; border: 1px solid #e4f2ff">
                                                        <div class="row">
                                                            <div class="col-12">
                                                                <!-- Sign in Form -->
                                                                <form class="sherah-wc__form-main sherah-wc__form-profile sherah-form-main--v2 p-0" method="post">
                                                                    <div class="row">
                                                                        <div class="col-lg-6 col-md-6 col-12">
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">First Name *</label>
                                                                                <div class="form-group__input">
                                                                                    <input type="text" name="formType" value="profileForm" style="display:none;" />
                                                                                    <input type="text" asp-for="ProfileVM.Id" name="ProfileVM.Id" value="@user.Id" style="display:none;" />
                                                                                    <input type ="text" 
                                                                                           asp-for="ProfileVM.FirstName"
                                                                                           name="ProfileVM.FirstName"
                                                                                           value="@user.FirstName"
                                                                                           class="sherah-wc__form-input"
                                                                                           placeholder="Your First Name">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-lg-6 col-md-6 col-12">
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">Last Name *</label>
                                                                                <div class="form-group__input">
                                                                                    <input type="text"
                                                                                           asp-for="ProfileVM.LastName"
                                                                                           name="ProfileVM.LastName"
                                                                                           value="@user.LastName" 
                                                                                           class="sherah-wc__form-input" 
                                                                                           placeholder="Your Last Name">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-lg-6 col-md-6 col-12">
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">Phone Number</label>
                                                                                <div class="form-group__input">
                                                                                    <input type="text"
                                                                                           asp-for="ProfileVM.Phone"
                                                                                           name="ProfileVM.Phone"
                                                                                           value="@user.Phone"
                                                                                           class="sherah-wc__form-input"
                                                                                           placeholder="Your Phone Number">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-lg-6 col-md-6 col-12">
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">Email Address *</label>
                                                                                <div class="form-group__input">
                                                                                    <input type="text"
                                                                                           asp-for="ProfileVM.Email"
                                                                                           name="ProfileVM.Email"
                                                                                           value="@user.Email" 
                                                                                           class="sherah-wc__form-input"
                                                                                           placeholder="Your Email">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-lg-6 col-md-6 col-12">
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">Headline</label>
                                                                                <div class="form-group__input">
                                                                                    <input type="text"
                                                                                           asp-for="ProfileVM.Headline"
                                                                                           name="ProfileVM.Headline"
                                                                                           value="@user.Profile.Headline" 
                                                                                           class="sherah-wc__form-input"
                                                                                           placeholder="Your Headline">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-lg-6 col-md-6 col-12">
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">Website</label>
                                                                                <div class="form-group__input">
                                                                                    <input type="text"
                                                                                           asp-for="ProfileVM.Website"
                                                                                           name="ProfileVM.Website"
                                                                                           class="sherah-wc__form-input"
                                                                                           placeholder="www.workflex.com">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-lg-6 col-md-6 col-12">
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">Street</label>
                                                                                <div class="form-group__input">
                                                                                    <input type="text"
                                                                                           asp-for="ProfileVM.Street"
                                                                                           name="ProfileVM.Street"
                                                                                           class="sherah-wc__form-input"
                                                                                           placeholder="Your Street">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-lg-6 col-md-6 col-12">
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">Apartment (Optional)</label>
                                                                                <div class="form-group__input">
                                                                                    <input type="text"
                                                                                           asp-for="ProfileVM.Apartment"
                                                                                           name="ProfileVM.Apartment"
                                                                                           class="sherah-wc__form-input"
                                                                                           placeholder="Your Apartment">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-lg-4 col-md-6 col-12">
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">Province</label>
                                                                                <select asp-for="ProfileVM.Province" id="city"></select>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-lg-4 col-md-6 col-12">
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">District</label>
                                                                                <select asp-for="ProfileVM.District" id="district"></select>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-lg-4 col-md-6 col-12">
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">Ward</label>
                                                                                <select asp-for="ProfileVM.Ward" id="ward"></select>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-12">
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">About Description</label>
                                                                                <div class="form-group__input">
                                                                                    <textarea type="text"
                                                                                              asp-for="ProfileVM.AboutDescription"
                                                                                              name="ProfileVM.AboutDescription"
                                                                                              class="sherah-wc__form-input"
                                                                                              placeholder="About description write here">
                                                                                              @user.Profile.Summary
                                                                                    </textarea>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <div class="form-group mg-top-30 sherah-dflex sherah-dflex-gap-30 justify-content-end">
                                                                        <button type="submit" class="sherah-btn sherah-btn__primary">Save</button>
                                                                        <!-- <button type="button" class="sherah-btn sherah-btn__third">Cancel</button> -->
                                                                    </div>
                                                                </form>
                                                                <!-- End Sign in Form -->
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="tab-pane fade" id="tab_3" role="tabpanel" aria-labelledby="nav-home-tab" style="padding: 0 10px; border: 1px solid #e4f2ff">
                                                        <div class="row">
                                                            <div class="col-12">
                                                                <!-- Sign in Form -->
                                                                <form class="sherah-wc__form-main sherah-wc__form-profile sherah-form-main--v2 p-0" method="post">
                                                                    <div class="row">
                                                                        <div class="col-lg-8 col-md-8 col-12">
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">Old Password *</label>
                                                                                <div class="form-group__input">
                                                                                    <input type="text" name="formType" value="passwordForm" style="display:none;" />
                                                                                    <input type="text" asp-for="ProfileVM.Id" name="ProfileVM.Id" value="@user.Id" style="display:none;" />
                                                                                    <input type="password"
                                                                                           asp-for="ProfileVM.OldPassword"
                                                                                           name="ProfileVM.OldPassword"
                                                                                           class="sherah-wc__form-input"
                                                                                           placeholder="&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;">
                                                                                </div>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">New Password *</label>
                                                                                <div class="form-group__input">
                                                                                    <input type ="password" 
                                                                                           asp-for="ProfileVM.NewPassword"
                                                                                           name="ProfileVM.NewPassword"
                                                                                           class="sherah-wc__form-input"
                                                                                           placeholder="&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;" 
                                                                                    >
                                                                                </div>
                                                                            </div>
                                                                            <div class="form-group">
                                                                                <label class="sherah-wc__form-label">Re-enter Password *</label>
                                                                                <div class="form-group__input">
                                                                                    <input type="password"
                                                                                           asp-for="ProfileVM.ReEnterPassword"
                                                                                           name="ProfileVM.ReEnterPassword"
                                                                                           class="sherah-wc__form-input"
                                                                                           placeholder="&#9679;&#9679;&#9679;&#9679;&#9679;&#9679;">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-lg-4 col-md-4 col-12">
                                                                            <div class="sherah-password__img" style="margin-top: 25px;">
                                                                                <img src="~/img/hero/p-update-img.png" alt="Change Password">
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <div class="form-group mg-top-30 sherah-dflex sherah-dflex-gap-30 justify-content-end">
                                                                        <button type="submit" class="sherah-btn sherah-btn__primary">Change Password</button>
                                                                    </div>
                                                                </form>
                                                                <!-- End Sign in Form -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                        <!-- End Profile Overview -->
                                    </div>
                                </div>
                            </div>
                            <!-- End Profile Inner Section -->
                        </div>
                    </div>
                    <!-- End Dashboard Inner -->
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        const fullAddress = "@Html.Raw(user!.Location)";
        const host = "https://vapi.vnappmob.com/api/";
        const apiProvince = host + 'province/';
        const isYourProfile = @Model.IsYourProfile.ToString().ToLower();

        document.addEventListener("DOMContentLoaded", () => {
            if (fullAddress) {
                document.querySelector('#address-information').textContent = extractCityProvince(fullAddress);
            } else {
                document.querySelector('#address-information').textContent = 'Location not updated yet.';
            }

            if (isYourProfile) {
                setLocationOptions(fullAddress);
                callAPI(apiProvince);

                document.querySelector("#city").addEventListener("change", () => {
                    const cityId = getSelectedDataId("#city");
                    if (cityId) callApiDistrict(host + "province/district/" + cityId);
                });

                document.querySelector("#district").addEventListener("change", () => {
                    const districtId = getSelectedDataId("#district");
                    if (districtId) callApiWard(host + "province/ward/" + districtId);
                });
            }
        });

        function setLocationOptions(address) {
            const parts = address.split(',');

            const province = document.querySelector('#city');
            const district = document.querySelector('#district');
            const ward = document.querySelector('#ward');

            if (parts.length > 4) {
                setTextContent(province, parts[4]);
                setTextContent(district, parts[3]);
                setTextContent(ward, parts[2]);
            } else {
                setTextContent(province, parts[3]);
                setTextContent(district, parts[2]);
                setTextContent(ward, parts[1]);
            }
        }

        function setTextContent(element, text) {
            if (!text) {
                element.textContent = '';
                element.value = '';
                return;
            }

            const trimmedText = text.trim();

            const option = document.createElement('option');
            option.textContent = trimmedText;
            option.value = trimmedText;
            option.selected = true;

            element.appendChild(option);
        }

        function extractCityProvince(fullAddress) {
            if (!fullAddress) {
                return '';
            }
            const addressParts = fullAddress.split(',');
            const maxIndex = Math.min(5, addressParts.length - 1);
            const city = addressParts[maxIndex - 1].trim();
            const province = addressParts[maxIndex].trim();
            return city + ', ' + province;
        }

        function callAPI(api) {
            axios.get(api)
                .then((response) => {
                    renderData(response.data, "city", renderDataCity);
                })
                .catch((error) => {
                    console.error("Error fetching province data:", error);
                });
        }

        function callApiDistrict(api) {
            axios.get(api)
                .then((response) => {
                    renderData(response.data, "district", renderDataDistrict);
                })
                .catch((error) => {
                    console.error("Error fetching district data:", error);
                });
        }

        function callApiWard(api) {
            axios.get(api)
                .then((response) => {
                    renderData(response.data, "ward", renderDataWard);
                })
                .catch((error) => {
                    console.error("Error fetching ward data:", error);
                });
        }

        function renderData(data, select, renderFunction) {
            if (data && data.results && Array.isArray(data.results)) {
                renderFunction(data.results, select);
            } else {
                console.error(`Invalid or missing ${select} data:`, data);
            }
        }

        function renderDataCity(results, select) {
            let selectElement = document.querySelector("#" + select);
            if (!selectElement.getAttribute('data-loaded')) {
                let row = '';
                if (!selectElement.value) {
                    row += '<option disable value="" selected>Choose Provinces</option>';
                }
                results.forEach((element) => {
                    row += `<option data-id="${element.province_id}" value="${element.province_name}">${element.province_name}</option>`;
                });
                selectElement.innerHTML += row;
                selectElement.setAttribute('data-loaded', 'true');
            }
        }

        function renderDataDistrict(results, select) {
            let row = '<option disable value="" selected>Choose Districts</option>';
            results.forEach((element) => {
                row += `<option data-id="${element.district_id}" value="${element.district_name}">${element.district_name}</option>`;
            });
            document.querySelector("#" + select).innerHTML = row;
        }

        function renderDataWard(results, select) {
            let row = '<option disable value="" selected>Choose Wards</option>';
            results.forEach((element) => {
                row += `<option data-id="${element.ward_id}" value="${element.ward_name}">${element.ward_name}</option>`;
            });
            document.querySelector("#" + select).innerHTML = row;
        }

        function getSelectedDataId(select) {
            const selectedOption = document.querySelector(select).selectedOptions[0];
            return selectedOption ? selectedOption.getAttribute('data-id') : null;
        }
    </script>
}
